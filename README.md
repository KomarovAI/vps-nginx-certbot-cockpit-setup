# VPS Setup Script v3.3 - Production Ready + Marzban
–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VPS —Å Nginx, SSL, Docker, Cockpit –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º Marzban VPN —Å–µ—Ä–≤–µ—Ä–æ–º.

## üéÜ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ v3.3 (–°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
- ‚úÖ "no such table: users" - –ü–û–õ–ù–û–°–¢–¨–Æ –£–°–¢–†–ê–ù–ï–ù–ê - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –æ–±—Ä–∞–∑
- ‚úÖ –ù–∞–¥—ë–∂–Ω—ã–π –∑–∞–ø—É—Å–∫ - –Ω–µ—Ç –±–æ–ª—å—à–µ —Ü–∏–∫–ª–æ–≤ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Marzban –æ–±—Ä–∞–∑
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ - –ª—É—á—à–∏–µ health checks –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- üîß –£–±—Ä–∞–Ω—ã –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å–±–æ—Ä–∫–∏ - –∏—Å—Ç–æ—á–Ω–∏–∫ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
- üîß –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø—É—Ç–∏ –ë–î - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `db.sqlite3`
- üîß –£–ª—É—á—à–µ–Ω—ã health checks - Python requests –≤–º–µ—Å—Ç–æ curl
- üîß –£–ø—Ä–æ—â–µ–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - –º–µ–Ω—å—à–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –±–æ–ª—å—à–µ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
- üîß –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ Marzban

## üöÄ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- ‚úÖ Nginx —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ Let's Encrypt SSL —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ Docker + Docker Compose –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
- ‚úÖ Cockpit –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ UFW Firewall —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- ‚úÖ Fail2ban –∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞

### Marzban VPN —Å–µ—Ä–≤–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π `gozargah/marzban:latest`
- ‚úÖ VLESS Reality –ø—Ä–æ—Ç–æ–∫–æ–ª —Å –º–∞—Å–∫–∏—Ä–æ–≤–∫–æ–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ - –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- ‚úÖ –í–µ–±-–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å SSL –∑–∞—â–∏—Ç–æ–π

---

## üåê –ù–æ–≤–æ–µ: –î–µ–ø–ª–æ–π –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∞–π—Ç–∞ (service.moscow) –≤–º–µ—Å—Ç–µ —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ Marzban, Nginx, Cockpit –∏ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∞–π—Ç–∞ –∏–∑ Docker-–æ–±—Ä–∞–∑–∞ `ghcr.io/komarovai/service.moscow` —á–µ—Ä–µ–∑ –æ–±—â–∏–π docker-compose.

- –û–±—Ä–∞–∑: `ghcr.io/komarovai/service.moscow:${IMAGE_TAG:-latest}`
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
  - `IMAGE_TAG` ‚Äî —Ç–µ–≥ –æ–±—Ä–∞–∑–∞ —Å–∞–π—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `latest`)
  - `WEBSITE_PORT` ‚Äî –≤–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç —Å–∞–π—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `3000`), –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ—Ä—Ç `80`
- –°–µ—Ç—å: –æ–±—â–∏–π `marzban-network` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—Ç–Ω—ã–º –ø—Ä–æ–∫—Å–∏ Nginx

### –ü—Ä–∏–º–µ—Ä compose-–±–ª–æ–∫–∞ (—É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ marzban/docker-compose.yml):
```yaml
  service-moscow:
    image: ghcr.io/komarovai/service.moscow:${IMAGE_TAG:-latest}
    container_name: service-moscow
    restart: unless-stopped
    ports:
      - "${WEBSITE_PORT:-3000}:80"
    networks:
      - marzban-network
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

### –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ IMAGE_TAG
–ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–∞–π—Ç –±–µ–∑ –ø—Ä–∞–≤–∫–∏ compose-—Ñ–∞–π–ª–∞, –º–µ–Ω—è—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è.

- –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ (—Ä–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Å –Ω—É–∂–Ω—ã–º —Ç–µ–≥–æ–º):
```bash
IMAGE_TAG=latest WEBSITE_PORT=3000 docker compose -f marzban/docker-compose.yml up -d service-moscow
```

- –ü–æ—Å—Ç–æ—è–Ω–Ω–æ (—á–µ—Ä–µ–∑ .env —Ä—è–¥–æ–º —Å docker-compose):
```env
IMAGE_TAG=latest
WEBSITE_PORT=3000
```
–ü–æ—Å–ª–µ –ø—Ä–∞–≤–∫–∏ .env:
```bash
docker compose -f marzban/docker-compose.yml up -d service-moscow
```

- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏:
```bash
IMAGE_TAG=latest docker compose -f marzban/docker-compose.yml pull service-moscow
IMAGE_TAG=latest docker compose -f marzban/docker-compose.yml up -d service-moscow
```

### –°–æ–≤–º–µ—Å—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤—Å–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (Marzban, —Å–∞–π—Ç, –∏ —Ç.–¥.)
IMAGE_TAG=latest WEBSITE_PORT=3000 \
  docker compose -f marzban/docker-compose.yml up -d
```

–ï—Å–ª–∏ Nginx-–ø—Ä–æ–∫—Å–∏ –∏ SSL –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏ ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–º–µ–Ω –∏ –±—ç–∫–µ–Ω–¥-—Ä–æ—É—Ç–∏–Ω–≥ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ WEBSITE_PORT –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–∏—Å –ø–æ –∏–º–µ–Ω–∏ `service-moscow` –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏ `marzban-network`.

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
# –õ–æ–≥–∏ —Å–∞–π—Ç–∞
docker logs -f service-moscow
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker inspect --format='{{json .State.Health}}' service-moscow | jq
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
curl -I http://localhost:${WEBSITE_PORT:-3000}
```

---

## ‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
1) –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (Nginx, Docker, SSL, Cockpit)
2) –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `marzban/docker-compose.yml`
3) –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–ª–æ–∫ `service-moscow` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Å–º. –≤—ã—à–µ)
4) –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É:
```bash
IMAGE_TAG=latest WEBSITE_PORT=3000 docker compose -f marzban/docker-compose.yml up -d
```
5) –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx proxy –Ω–∞ –¥–æ–º–µ–Ω —Å–∞–π—Ç–∞, –ø—Ä–æ–∫—Å–∏—Ä—É—è –Ω–∞ `service-moscow:80` (–≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏) –∏–ª–∏ –Ω–∞ `127.0.0.1:${WEBSITE_PORT}` (—Å–Ω–∞—Ä—É–∂–∏)

–ì–æ—Ç–æ–≤–æ ‚Äî Marzban, Cockpit, Nginx –∏ –≤–∞—à —Å–∞–π—Ç –∑–∞–ø—É—â–µ–Ω—ã –≤–º–µ—Å—Ç–µ.
