#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è VPS –æ–∫—Ä—É–∂–µ–Ω–∏—è
# –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º—É, SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–ª—É–∂–±—ã

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warning() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [[ $EUID -ne 0 ]]; then
   error "–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
   exit 1
fi

log "–ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è VPS –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
log "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ Ubuntu..."
apt update && apt upgrade -y
if [ $? -eq 0 ]; then
    log "–ü–∞–∫–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
else
    error "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤"
    exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ snap –ø–∞–∫–µ—Ç–æ–≤
log "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ snap –ø–∞–∫–µ—Ç–æ–≤..."
snap refresh

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
if command -v certbot &> /dev/null; then
    certbot renew --quiet
    if [ $? -eq 0 ]; then
        log "SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã"
    else
        warning "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
    fi
else
    warning "Certbot –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
nginx -t
if [ $? -eq 0 ]; then
    log "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    error "–û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx!"
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±
log "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±..."

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
systemctl reload nginx
if [ $? -eq 0 ]; then
    log "Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
else
    warning "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Nginx"
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Cockpit
systemctl restart cockpit
if [ $? -eq 0 ]; then
    log "Cockpit –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
else
    warning "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Cockpit"
fi

# –û—á–∏—Å—Ç–∫–∞ –Ω–µ–Ω—É–∂–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
log "–û—á–∏—Å—Ç–∫–∞ –Ω–µ–Ω—É–∂–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
apt autoremove -y
apt autoclean

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö —Å–ª—É–∂–±
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–ª—É–∂–±..."
if [ -f "/root/check-services.sh" ]; then
    /root/check-services.sh
else
    # –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    echo "=== –°—Ç–∞—Ç—É—Å —Å–ª—É–∂–± ==="
    systemctl status nginx --no-pager -l | head -5
    echo ""
    systemctl status cockpit --no-pager -l | head -5
    echo ""
    echo "=== –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã ==="
    ss -tlnp | grep -E ':(80|443|9090)'
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
if [ -f "/var/www/botinger789298.work.gd/index.html" ]; then
    log "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–∞–π—Ç–µ..."
    sed -i "s/–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:.*</–û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date '+%B %d, %Y, %H:%M MSK')</g" /var/www/botinger789298.work.gd/index.html
fi

log "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
log ""
log "üìã –°–≤–æ–¥–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
log "‚Ä¢ –ü–∞–∫–µ—Ç—ã Ubuntu: –û–±–Ω–æ–≤–ª–µ–Ω—ã"
log "‚Ä¢ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã: –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã"
log "‚Ä¢ Nginx: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
log "‚Ä¢ Cockpit: –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
log "‚Ä¢ –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: $(date '+%Y-%m-%d %H:%M:%S')"
log ""
log "üåê –°–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
log "‚Ä¢ –°–∞–π—Ç: https://botinger789298.work.gd"
log "‚Ä¢ Cockpit: https://botinger789298.work.gd:9090"